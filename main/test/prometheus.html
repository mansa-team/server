<!-- Ciolfi vai fazer bonitinho depois, isso é só um teste de consumo de API, queria ver como tava, vida longa ao Gemini 3 -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mansa</title>
    
    <link rel="icon" type="image/x-icon" href="https://mansa-team.github.io/icons/icons/MANSA.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

    <style>
        body {
            font-family: sans-serif;
            background: #fff;
            color: #000;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }

        .sidebar {
            border-bottom: 2px solid #000;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .message.user { background: #f0f0f0; }
        .message.assistant { background: #fff; }

        .avatar { font-weight: bold; margin-bottom: 5px; display: block; }

        .input-box {
            display: flex;
            gap: 10px;
        }

        .input-box input {
            flex: 1;
            padding: 8px;
        }

        .chart-wrapper {
            border: 1px solid #000;
            margin: 10px 0;
            padding: 10px;
            height: 300px;
        }

        .settings-group { display: inline-block; margin-right: 20px; }
        .settings-group label { display: block; font-size: 10px; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="settings-group">
            <label>API</label>
            <input type="text" id="apiEndpoint" value="http://localhost:3200/prometheus">
        </div>
        <div class="settings-group">
            <label>Key</label>
            <input type="password" id="apiKey" value="">
        </div>
        <button onclick="clearChat()">Limpar</button>
    </aside>

    <main class="main-content">
        <div class="chat-container" id="chatContainer">
            <!-- Messages go here -->
            <div class="message assistant">
                <div class="avatar assistant">
                    <span class="material-icons">smart_toy</span>
                </div>
                <div class="message-body">
                    Ola! Sou o <strong>Prometheus</strong>, sua inteligência financeira da Mansa. Como posso ajudar com suas análises hoje?
                </div>
            </div>
        </div>

        <div class="input-wrapper">
            <div class="input-box">
                <input type="text" id="userInput" placeholder="Faça uma pergunta sobre o mercado financeiro..." autocomplete="off">
                <button id="sendBtn" class="icon-btn send" title="Enviar Mensagem">
                    <span class="material-icons">send</span>
                </button>
            </div>
        </div>
    </main>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const apiEndpointInput = document.getElementById('apiEndpoint');
        const apiKeyInput = document.getElementById('apiKey');

        // Configure Marked
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${role}`;
            avatar.innerHTML = `<span class="material-icons">${role === 'user' ? 'person' : 'smart_toy'}</span>`;
            
            const messageBody = document.createElement('div');
            messageBody.className = 'message-body';
            
            if (role === 'assistant') {
                // Process Charts first
                // Robust regex for <chart config="..." /> or <chart config='...' />
                let processedContent = content.replace(/<chart\s+config=(['"])(.*?)\1\s*\/?>/g, (match, quote, configStr) => {
                    const id = 'chart-' + Math.random().toString(36).substr(2, 9);
                    setTimeout(() => renderChart(id, configStr), 100);
                    return `<div id="${id}" class="chart-wrapper" style="min-height: 250px; margin: 20px 0;"></div>`;
                });

                const cleanHTML = DOMPurify.sanitize(marked.parse(processedContent));
                messageBody.innerHTML = cleanHTML;
            } else {
                messageBody.textContent = content;
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageBody);
            chatContainer.appendChild(messageDiv);
            
            // Syntax highlighting for new code blocks
            messageBody.querySelectorAll('pre code').forEach(hljs.highlightElement);
            
            scrollToBottom();
        }

        function renderChart(containerId, configStr) {
            const container = document.getElementById(containerId);
            try {
                let cleanStr = configStr.trim().replace(/&quot;/g, '"');
                const config = JSON.parse(cleanStr);
                
                const trace = {
                    x: config.data.labels,
                    y: config.data.datasets[0].data,
                    type: config.type || 'bar',
                    marker: { color: '#000' }
                };

                const layout = {
                    height: 280,
                    margin: { t: 10, b: 30, l: 30, r: 10 }
                };

                Plotly.newPlot(container, [trace], layout, { responsive: true, displayModeBar: false });
            } catch (e) {
                container.innerHTML = 'Erro gráfico';
            }
        }

        async function handleSend() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';
            
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = loadingId;
            loadingDiv.innerHTML = `
                <div class="avatar assistant"><span class="material-icons">smart_toy</span></div>
                <div class="message-body">
                    <div class="typing-indicator">
                        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            scrollToBottom();

            try {
                const url = new URL(apiEndpointInput.value);
                url.searchParams.append('text', text);

                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': apiKeyInput.value
                    }
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.success) {
                    addMessage(data.response, 'assistant');
                } else {
                    addMessage(`**Erro:** ${data.error || 'Falha na requisição'}`, 'assistant');
                }
            } catch (err) {
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();
                addMessage(`**Erro de Conexão:** ${err.message}`, 'assistant');
            }
        }

        function scrollToBottom() {
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        function clearChat() {
            chatContainer.innerHTML = '';
            addMessage('Chat limpo. Como posso ajudar agora?', 'assistant');
        }

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
        });

        sendBtn.addEventListener('click', handleSend);
    </script>
</body>
</html>